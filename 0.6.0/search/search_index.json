{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Django Nested Values","text":"<p>An experimental package that adds <code>.values_nested()</code> to Django querysets, returning nested dictionaries with related objects included.</p>"},{"location":"#quick-example","title":"Quick Example","text":"<pre><code>from django_nested_values import NestedValuesQuerySet\n\nclass Book(models.Model):\n    title = models.CharField(max_length=200)\n    publisher = models.ForeignKey(Publisher, on_delete=models.CASCADE)\n    authors = models.ManyToManyField(\"Author\")\n\n    objects = NestedValuesQuerySet.as_manager()\n\n# Returns dicts with nested related data\nbooks = (\n    Book.objects\n    .only(\"title\")\n    .select_related(\"publisher\")\n    .prefetch_related(\"authors\")\n    .values_nested()\n)\n# [{\"id\": 1, \"title\": \"...\", \"publisher\": {\"id\": 1, \"name\": \"...\"}, \"authors\": [...]}, ...]\n</code></pre>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>Familiar API: Uses standard Django patterns (<code>only()</code>, <code>select_related()</code>, <code>prefetch_related()</code>)</li> <li>ForeignKey via JOIN: <code>select_related()</code> uses efficient single-query JOINs</li> <li>M2M/Reverse FK via prefetch: <code>prefetch_related()</code> for multi-valued relations</li> <li>No model instantiation: Returns dicts directly from the database</li> </ul>"},{"location":"#requirements","title":"Requirements","text":"<ul> <li>Python 3.13+</li> <li>Django 5.2+</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#supported-versions","title":"Supported Versions","text":"Python 3.13 Python 3.14 Django 5.2 \u2713 \u2713 Django 6.0 \u2713 \u2713"},{"location":"getting-started/installation/#install-from-pypi","title":"Install from PyPI","text":"<pre><code>pip install django-nested-values\n</code></pre> <p>Or with uv:</p> <pre><code>uv add django-nested-values\n</code></pre>"},{"location":"getting-started/installation/#development-installation","title":"Development Installation","text":"<pre><code>git clone https://github.com/oliverhaas/django-nested-values.git\ncd django-nested-values\nuv venv\nuv sync --group dev\n</code></pre>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":""},{"location":"getting-started/quickstart/#setup","title":"Setup","text":"<p>Add <code>NestedValuesQuerySet</code> as your model's manager:</p> <pre><code>from django.db import models\nfrom django_nested_values import NestedValuesQuerySet\n\n\nclass Publisher(models.Model):\n    name = models.CharField(max_length=100)\n\n    objects = NestedValuesQuerySet.as_manager()\n\n\nclass Author(models.Model):\n    name = models.CharField(max_length=100)\n\n    objects = NestedValuesQuerySet.as_manager()\n\n\nclass Book(models.Model):\n    title = models.CharField(max_length=200)\n    publisher = models.ForeignKey(Publisher, on_delete=models.CASCADE)\n    authors = models.ManyToManyField(Author, related_name=\"books\")\n\n    objects = NestedValuesQuerySet.as_manager()\n</code></pre>"},{"location":"getting-started/quickstart/#with-custom-queryset","title":"With Custom QuerySet","text":"<p>If you have a custom QuerySet, use <code>NestedValuesQuerySetMixin</code> instead:</p> <pre><code>from django.db.models import QuerySet\nfrom django_nested_values import NestedValuesQuerySetMixin\n\n\nclass BookQuerySet(NestedValuesQuerySetMixin, QuerySet):\n    def published(self):\n        return self.filter(is_published=True)\n\n\nclass Book(models.Model):\n    title = models.CharField(max_length=200)\n    is_published = models.BooleanField(default=False)\n\n    objects = BookQuerySet.as_manager()\n\n# Chain custom methods with values_nested()\nBook.objects.published().prefetch_related(\"authors\").values_nested()\n</code></pre>"},{"location":"getting-started/quickstart/#ad-hoc-usage-no-model-changes","title":"Ad-hoc Usage (No Model Changes)","text":"<p>Use <code>NestedValuesQuerySet</code> directly without modifying your models:</p> <pre><code>from django_nested_values import NestedValuesQuerySet\n\n# Instantiate with any model\nqs = NestedValuesQuerySet(model=Book)\nresult = list(\n    qs.filter(is_published=True)\n    .select_related(\"publisher\")\n    .prefetch_related(\"authors\")\n    .values_nested()\n)\n</code></pre>"},{"location":"getting-started/quickstart/#basic-usage","title":"Basic Usage","text":"<pre><code># Get all fields as nested dicts\nbooks = Book.objects.select_related(\"publisher\").prefetch_related(\"authors\").values_nested()\n# [{\"id\": 1, \"title\": \"...\", \"publisher\": {...}, \"authors\": [...]}, ...]\n\n# Control which fields with only()\nbooks = Book.objects.only(\"title\").prefetch_related(\"authors\").values_nested()\n# [{\"id\": 1, \"title\": \"...\", \"authors\": [...]}, ...]\n</code></pre>"},{"location":"getting-started/quickstart/#foreignkey-select_related-vs-prefetch_related","title":"ForeignKey: select_related vs prefetch_related","text":"<p>For ForeignKey relations, use <code>select_related()</code> for efficient JOINs:</p> <pre><code># Efficient: 1 query with JOIN\nbooks = Book.objects.select_related(\"publisher\").values_nested()\n\n# Less efficient: 2 queries (books + publishers)\nbooks = Book.objects.prefetch_related(\"publisher\").values_nested()\n</code></pre> <p>Both return the same nested structure: <pre><code>{\"id\": 1, \"title\": \"...\", \"publisher\": {\"id\": 1, \"name\": \"...\", \"country\": \"...\"}}\n</code></pre></p>"},{"location":"getting-started/quickstart/#manytomany-and-reverse-foreignkey","title":"ManyToMany and Reverse ForeignKey","text":"<p>For M2M and reverse FK, use <code>prefetch_related()</code>:</p> <pre><code># ManyToMany\nbooks = Book.objects.prefetch_related(\"authors\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"authors\": [{\"id\": 1, \"name\": \"...\"}, ...]}\n\n# Reverse ForeignKey\nbooks = Book.objects.prefetch_related(\"chapters\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"chapters\": [{\"id\": 1, \"title\": \"Chapter 1\"}, ...]}\n</code></pre>"},{"location":"getting-started/quickstart/#controlling-related-fields","title":"Controlling Related Fields","text":"<p>Use <code>Prefetch</code> objects with <code>only()</code> to control which fields are included:</p> <pre><code>from django.db.models import Prefetch\n\n# Only fetch author names\nbooks = Book.objects.only(\"title\").prefetch_related(\n    Prefetch(\"authors\", queryset=Author.objects.only(\"name\"))\n).values_nested()\n# {\"id\": 1, \"title\": \"...\", \"authors\": [{\"id\": 1, \"name\": \"...\"}]}\n\n# Filter prefetched data\nbooks = Book.objects.only(\"title\").prefetch_related(\n    Prefetch(\"authors\", queryset=Author.objects.filter(name__startswith=\"A\"))\n).values_nested()\n\n# Custom to_attr\nbooks = Book.objects.only(\"title\").prefetch_related(\n    Prefetch(\"chapters\", queryset=Chapter.objects.filter(number=1), to_attr=\"first_chapter\")\n).values_nested()\n# {\"id\": 1, \"title\": \"...\", \"first_chapter\": [{\"id\": 1, \"title\": \"Introduction\"}]}\n</code></pre>"},{"location":"getting-started/quickstart/#combining-relations","title":"Combining Relations","text":"<p>Mix <code>select_related()</code> and <code>prefetch_related()</code>:</p> <pre><code>books = (\n    Book.objects\n    .only(\"title\")\n    .select_related(\"publisher\")           # FK: 1 query with JOIN\n    .prefetch_related(\"authors\", \"tags\")   # M2M: +2 queries\n    .values_nested()\n)\n# Total: 3 queries\n# {\"id\": 1, \"title\": \"...\", \"publisher\": {...}, \"authors\": [...], \"tags\": [...]}\n</code></pre>"},{"location":"getting-started/quickstart/#use-case-api-endpoints","title":"Use Case: API Endpoints","text":"<p>The main use case is APIs where data gets passed to Pydantic models:</p> Approach Flow Standard Django DB \u2192 Django Model \u2192 dict \u2192 Pydantic django-nested-values DB \u2192 dict \u2192 Pydantic <pre><code>from ninja import NinjaAPI\n\n@api.get(\"/books\", response=list[BookSchema])\ndef list_books(request):\n    return list(\n        Book.objects\n        .only(\"id\", \"title\")\n        .select_related(\"publisher\")\n        .prefetch_related(\"authors\")\n        .values_nested()\n    )\n</code></pre>"},{"location":"getting-started/quickstart/#benchmark","title":"Benchmark","text":"<p>The included benchmark (<code>benchmarks/benchmark.py</code>) tests fetching 1000 books with multiple relations. Both approaches use the same number of database queries.</p> <pre><code>uv run python benchmarks/benchmark.py\n</code></pre>"},{"location":"reference/api/","title":"API Reference","text":""},{"location":"reference/api/#nestedvaluesqueryset","title":"NestedValuesQuerySet","text":"<p>A ready-to-use QuerySet that adds <code>.values_nested()</code> to return nested dictionaries with related objects.</p> <p>Inherits from <code>NestedValuesQuerySetMixin</code> and <code>django.db.models.QuerySet</code>.</p>"},{"location":"reference/api/#setup","title":"Setup","text":"<pre><code>from django_nested_values import NestedValuesQuerySet\n\nclass MyModel(models.Model):\n    objects = NestedValuesQuerySet.as_manager()\n</code></pre>"},{"location":"reference/api/#ad-hoc-usage","title":"Ad-hoc Usage","text":"<p>Use directly without modifying models:</p> <pre><code>from django_nested_values import NestedValuesQuerySet\n\nqs = NestedValuesQuerySet(model=Book)\nresult = list(qs.select_related(\"publisher\").prefetch_related(\"authors\").values_nested())\n</code></pre>"},{"location":"reference/api/#nestedvaluesquerysetmixin","title":"NestedValuesQuerySetMixin","text":"<p>A mixin class for adding <code>.values_nested()</code> to custom QuerySet classes.</p> <p>Use this when you have your own custom QuerySet and want to add <code>values_nested()</code> functionality.</p>"},{"location":"reference/api/#setup_1","title":"Setup","text":"<pre><code>from django.db.models import QuerySet\nfrom django_nested_values import NestedValuesQuerySetMixin\n\nclass MyCustomQuerySet(NestedValuesQuerySetMixin, QuerySet):\n    def published(self):\n        return self.filter(is_published=True)\n\n    def by_author(self, author_name):\n        return self.filter(authors__name=author_name)\n\nclass Book(models.Model):\n    objects = MyCustomQuerySet.as_manager()\n\n# Use custom methods alongside values_nested()\nBook.objects.published().by_author(\"John\").prefetch_related(\"authors\").values_nested()\n</code></pre>"},{"location":"reference/api/#values_nested","title":"values_nested()","text":"<p>Returns dictionaries with related objects included as nested dicts/lists.</p> <p>Takes no arguments. Use standard Django methods to control the output:</p> <ul> <li><code>.only()</code> - Select which fields to include</li> <li><code>.select_related()</code> - Include ForeignKey relations (single dict)</li> <li><code>.prefetch_related()</code> - Include M2M/reverse FK relations (list of dicts)</li> </ul> <pre><code># All fields, no relations\nBook.objects.values_nested()\n# [{\"id\": 1, \"title\": \"...\", \"isbn\": \"...\", ...}, ...]\n\n# Selected fields with relations\nBook.objects.only(\"title\").select_related(\"publisher\").prefetch_related(\"authors\").values_nested()\n# [{\"id\": 1, \"title\": \"...\", \"publisher\": {...}, \"authors\": [...]}, ...]\n</code></pre>"},{"location":"reference/api/#relation-types","title":"Relation Types","text":""},{"location":"reference/api/#foreignkey-select_related","title":"ForeignKey (select_related)","text":"<p>Use <code>select_related()</code> for efficient single-query JOINs. Returns a nested dict.</p> <pre><code>Book.objects.select_related(\"publisher\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"publisher\": {\"id\": 1, \"name\": \"...\", \"country\": \"...\"}}\n</code></pre>"},{"location":"reference/api/#foreignkey-prefetch_related","title":"ForeignKey (prefetch_related)","text":"<p>Also supported but less efficient (2 queries instead of 1). Returns a nested dict.</p> <pre><code>Book.objects.prefetch_related(\"publisher\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"publisher\": {\"id\": 1, \"name\": \"...\", \"country\": \"...\"}}\n</code></pre>"},{"location":"reference/api/#manytomany","title":"ManyToMany","text":"<p>Use <code>prefetch_related()</code>. Returns a list of dicts.</p> <pre><code>Book.objects.prefetch_related(\"authors\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"authors\": [{\"id\": 1, \"name\": \"...\"}, {\"id\": 2, \"name\": \"...\"}]}\n</code></pre>"},{"location":"reference/api/#reverse-foreignkey","title":"Reverse ForeignKey","text":"<p>Use <code>prefetch_related()</code>. Returns a list of dicts.</p> <pre><code>Book.objects.prefetch_related(\"chapters\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"chapters\": [{\"id\": 1, \"title\": \"Chapter 1\"}, ...]}\n</code></pre>"},{"location":"reference/api/#controlling-fields","title":"Controlling Fields","text":""},{"location":"reference/api/#main-model-fields","title":"Main Model Fields","text":"<p>Use <code>.only()</code> to select specific fields:</p> <pre><code>Book.objects.only(\"title\", \"price\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"price\": 29.99}\n</code></pre>"},{"location":"reference/api/#related-model-fields-select_related","title":"Related Model Fields (select_related)","text":"<p>Use <code>.only()</code> with double-underscore syntax:</p> <pre><code>Book.objects.only(\"title\", \"publisher__name\").select_related(\"publisher\").values_nested()\n# {\"id\": 1, \"title\": \"...\", \"publisher\": {\"id\": 1, \"name\": \"...\"}}\n</code></pre>"},{"location":"reference/api/#related-model-fields-prefetch_related","title":"Related Model Fields (prefetch_related)","text":"<p>Use <code>Prefetch</code> objects with <code>.only()</code> on the inner queryset:</p> <pre><code>from django.db.models import Prefetch\n\nBook.objects.only(\"title\").prefetch_related(\n    Prefetch(\"authors\", queryset=Author.objects.only(\"name\"))\n).values_nested()\n# {\"id\": 1, \"title\": \"...\", \"authors\": [{\"id\": 1, \"name\": \"...\"}]}\n</code></pre>"},{"location":"reference/api/#query-efficiency","title":"Query Efficiency","text":"Relation Type Method Queries ForeignKey <code>select_related()</code> 1 (JOIN) ForeignKey <code>prefetch_related()</code> 2 ManyToMany <code>prefetch_related()</code> 2 Reverse FK <code>prefetch_related()</code> 2"},{"location":"reference/api/#combined-example","title":"Combined Example","text":"<pre><code># 1 (JOIN for publisher) + 1 (prefetch authors) + 1 (prefetch tags) = 3 queries\nBook.objects.select_related(\"publisher\").prefetch_related(\"authors\", \"tags\").values_nested()\n</code></pre>"},{"location":"reference/api/#prefetch-objects","title":"Prefetch Objects","text":"<p>Full support for Django's <code>Prefetch</code> objects:</p> <pre><code>from django.db.models import Prefetch\n\n# Filter prefetched data\nBook.objects.prefetch_related(\n    Prefetch(\"chapters\", queryset=Chapter.objects.filter(page_count__gt=30))\n).values_nested()\n\n# Custom to_attr\nBook.objects.prefetch_related(\n    Prefetch(\"chapters\", queryset=Chapter.objects.filter(number=1), to_attr=\"first_chapter\")\n).values_nested()\n# {\"id\": 1, \"title\": \"...\", \"first_chapter\": [{\"id\": 1, \"title\": \"Introduction\"}]}\n</code></pre>"},{"location":"reference/changelog/","title":"Changelog","text":""},{"location":"reference/changelog/#unreleased","title":"[Unreleased]","text":""},{"location":"reference/changelog/#040","title":"[0.4.0]","text":"<ul> <li>Breaking: <code>values_nested()</code> no longer takes arguments</li> <li>New: Use <code>.only()</code> to control which fields are returned</li> <li>New: Use <code>.select_related()</code> for ForeignKey relations (efficient JOINs)</li> <li>New: Use <code>.prefetch_related()</code> for ManyToMany and reverse ForeignKey relations</li> </ul> <p>Migration from 0.3.0: <pre><code># Before (0.3.0)\nBook.objects.prefetch_related(\"authors\").values_nested(\"title\", \"authors\")\n\n# After (0.4.0)\nBook.objects.only(\"title\").prefetch_related(\"authors\").values_nested()\n</code></pre></p>"},{"location":"reference/changelog/#030","title":"[0.3.0]","text":"<ul> <li>Breaking: Package renamed from <code>django-prefetch-values</code> to <code>django-nested-values</code></li> <li>Breaking: Class renamed from <code>PrefetchValuesQuerySet</code> to <code>NestedValuesQuerySet</code></li> <li>Breaking: Method renamed from <code>.values()</code> to <code>.values_nested()</code> for API clarity</li> </ul>"},{"location":"reference/changelog/#010","title":"[0.1.0]","text":"<ul> <li>Initial release</li> <li><code>NestedValuesQuerySet</code> enabling <code>.prefetch_related().values_nested()</code> in Django ORM</li> <li>Support for ManyToMany, reverse ForeignKey, reverse ManyToMany relations</li> <li>Support for Django's <code>Prefetch</code> object with custom querysets and <code>to_attr</code></li> <li>Support for nested prefetches</li> </ul>"}]}